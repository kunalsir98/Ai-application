{% extends "base.html" %}

{% block title %}Image Generation - Simply ai {% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="display-6 fw-bold text-primary">AI Image Generation</h1>
                <p class="lead text-muted">Transform your ideas into stunning visuals with AI</p>
            </div>

            <div class="row">
                <!-- Input Section -->
                <div class="col-lg-4 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-magic me-2"></i>Create Image
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="image-generation-form">
                                <div class="mb-3">
                                    <label for="prompt-input" class="form-label">Image Description</label>
                                    <textarea class="form-control" id="prompt-input" name="prompt" rows="4" 
                                              placeholder="Describe the image you want to create..."></textarea>
                                    <div class="form-text">Be specific and descriptive for best results</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="style-select" class="form-label">Style</label>
                                    <select class="form-select" id="style-select">
                                        <option value="">Natural/Realistic</option>
                                        <option value="digital art">Digital Art</option>
                                        <option value="oil painting">Oil Painting</option>
                                        <option value="watercolor">Watercolor</option>
                                        <option value="cartoon">Cartoon</option>
                                        <option value="photorealistic">Photorealistic</option>
                                        <option value="abstract">Abstract</option>
                                        <option value="minimalist">Minimalist</option>
                                    </select>
                                </div>
                                
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-wand-magic-sparkles me-2"></i>Generate Image
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Sample Prompts -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-lightbulb me-2"></i>Sample Prompts
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-secondary btn-sm sample-prompt" 
                                        data-prompt="A futuristic city skyline at sunset with flying cars">
                                    Futuristic City
                                </button>
                                <button class="btn btn-outline-secondary btn-sm sample-prompt" 
                                        data-prompt="A peaceful mountain lake with snow-capped peaks reflected in crystal clear water">
                                    Mountain Lake
                                </button>
                                <button class="btn btn-outline-secondary btn-sm sample-prompt" 
                                        data-prompt="A steampunk robot playing chess with a cat in a Victorian library">
                                    Steampunk Scene
                                </button>
                                <button class="btn btn-outline-secondary btn-sm sample-prompt" 
                                        data-prompt="An underwater coral garden with bioluminescent fish and jellyfish">
                                    Underwater Garden
                                </button>
                                <button class="btn btn-outline-secondary btn-sm sample-prompt" 
                                        data-prompt="A cozy cabin in a snowy forest with warm light glowing from windows">
                                    Cozy Cabin
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Generated Images Section -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-image me-2"></i>Generated Image
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="image-output">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-image fa-4x mb-3"></i>
                                    <h5>Your generated image will appear here</h5>
                                    <p>Enter a description and click "Generate Image" to create AI art</p>
                                </div>
                            </div>
                            
                            <div id="image-actions" class="mt-3" style="display: none;">
                                <div class="d-flex gap-2 justify-content-center">
                                    <button class="btn btn-outline-primary" id="download-image">
                                        <i class="fas fa-download me-1"></i>Download
                                    </button>
                                    <button class="btn btn-outline-secondary" id="share-image">
                                        <i class="fas fa-share me-1"></i>Share
                                    </button>
                                    <button class="btn btn-outline-success" id="regenerate-image">
                                        <i class="fas fa-redo me-1"></i>Regenerate
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Generation History -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-history me-2"></i>Recent Generations
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="image-history" class="row g-2">
                                <div class="col-12 text-center text-muted">
                                    <p>Your recent generations will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('image-generation-form');
    const promptInput = document.getElementById('prompt-input');
    const styleSelect = document.getElementById('style-select');
    const imageOutput = document.getElementById('image-output');
    const imageActions = document.getElementById('image-actions');
    const imageHistory = document.getElementById('image-history');
    const samplePrompts = document.querySelectorAll('.sample-prompt');
    
    let currentImageUrl = '';
    let currentPrompt = '';
    let generationHistory = [];

    // Sample prompt buttons
    samplePrompts.forEach(button => {
        button.addEventListener('click', function() {
            promptInput.value = this.dataset.prompt;
        });
    });

    // Style selection enhancement
    styleSelect.addEventListener('change', function() {
        if (promptInput.value && this.value) {
            const currentPrompt = promptInput.value;
            if (!currentPrompt.includes(this.value)) {
                promptInput.value = `${currentPrompt}, ${this.value} style`;
            }
        }
    });

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const prompt = promptInput.value.trim();
        if (!prompt) {
            alert('Please enter an image description.');
            return;
        }
        
        currentPrompt = prompt;
        
        // Show loading state
        imageOutput.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Generating your image...</h5>
                <p class="text-muted">This may take 30-60 seconds</p>
                <div class="progress mt-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 100%"></div>
                </div>
            </div>
        `;
        
        try {
            const formData = new FormData(form);
            const response = await fetch('/image-generation', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.url) {
                displayGeneratedImage(result.url, prompt, result.provider);
                addToHistory(result.url, prompt, result.provider);
            } else {
                imageOutput.innerHTML = `
                    <div class="alert alert-danger text-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${result.error || 'Failed to generate image'}
                    </div>
                `;
            }
        } catch (error) {
            imageOutput.innerHTML = `
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error: ${error.message}
                </div>
            `;
        }
    });

    function displayGeneratedImage(imageUrl, prompt, provider) {
        currentImageUrl = imageUrl;
        
        imageOutput.innerHTML = `
            <div class="text-center">
                <img src="${imageUrl}" alt="Generated Image" class="img-fluid rounded shadow-lg" 
                     style="max-height: 500px;">
                <div class="mt-3">
                    <h6 class="text-muted">Prompt: "${prompt}"</h6>
                    <small class="text-muted">Generated using ${provider || 'AI'}</small>
                </div>
            </div>
        `;
        
        imageActions.style.display = 'block';
    }

    function addToHistory(imageUrl, prompt, provider) {
        const historyItem = {
            url: imageUrl,
            prompt: prompt,
            provider: provider,
            timestamp: new Date()
        };
        
        generationHistory.unshift(historyItem);
        
        // Keep only last 6 items
        if (generationHistory.length > 6) {
            generationHistory = generationHistory.slice(0, 6);
        }
        
        updateHistoryDisplay();
    }

    function updateHistoryDisplay() {
        if (generationHistory.length === 0) {
            imageHistory.innerHTML = `
                <div class="col-12 text-center text-muted">
                    <p>Your recent generations will appear here</p>
                </div>
            `;
            return;
        }
        
        imageHistory.innerHTML = generationHistory.map(item => `
            <div class="col-md-4 col-lg-3">
                <div class="card history-item" data-url="${item.url}" data-prompt="${item.prompt}">
                    <img src="${item.url}" class="card-img-top" alt="Generated Image" 
                         style="height: 100px; object-fit: cover;">
                    <div class="card-body p-2">
                        <small class="text-muted d-block" style="font-size: 0.75rem;">
                            ${item.prompt.substring(0, 30)}${item.prompt.length > 30 ? '...' : ''}
                        </small>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Add click handlers to history items
        document.querySelectorAll('.history-item').forEach(item => {
            item.addEventListener('click', function() {
                const url = this.dataset.url;
                const prompt = this.dataset.prompt;
                displayGeneratedImage(url, prompt);
            });
        });
    }

    // Download image
    document.getElementById('download-image').addEventListener('click', function() {
        if (currentImageUrl) {
            const a = document.createElement('a');
            a.href = currentImageUrl;
            a.download = `ai-generated-image-${Date.now()}.png`;
            a.click();
        }
    });

    // Share image
    document.getElementById('share-image').addEventListener('click', function() {
        if (navigator.share && currentImageUrl) {
            navigator.share({
                title: 'AI Generated Image',
                text: `Check out this AI-generated image: "${currentPrompt}"`,
                url: currentImageUrl
            });
        } else {
            // Fallback: copy URL to clipboard
            navigator.clipboard.writeText(currentImageUrl).then(() => {
                this.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-share me-1"></i>Share';
                }, 2000);
            });
        }
    });

    // Regenerate image
    document.getElementById('regenerate-image').addEventListener('click', function() {
        if (currentPrompt) {
            promptInput.value = currentPrompt;
            form.dispatchEvent(new Event('submit'));
        }
    });
});
</script>
{% endblock %}
